<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Safety Report</title>
    <style>
        table {
            width: 100%;
        }
        .page-break {
            page-break-after: always;
        }
        /** Define the margins of your page **/
        @page {
            margin: 10px 10px;
        }
        main {
            margin: 0px;
            padding: 0px;
        }
        #chart-table td,th {
            border: 1px solid black;
            border-collapse: collapse;
            text-align: center;
        }
    </style>
</head>
<body>
    <header>
        <table>
            <tr>
                <td style="text-align: left;width:33%;">
                    <img src="{{ $public_path }}/images/logo_blue.png"
                        style="height: 25px; width: auto; margin-top: 10px;" />
                </td>
                @if ($start_date != '' && $end_date != '')
                    <td style="text-align: center;width:33%;">
                        <i>{{ \Carbon\Carbon::Create($start_date)->format('m-d-Y') }} to
                            {{ \Carbon\Carbon::Create($end_date)->format('m-d-Y') }}</i>
                    </td>
                @else
                    <td style="text-align: center;width:33%;"><i>Date: {{ $date }}</i></td>
                @endif
                <td style="text-align: right;width:34%;font-size: 15px;">
                    <i>Location Name: <strong>{{ $location['name'] }}</strong></i><br>
                    <i>Location Code: <strong>{{ $location['code'] }}</strong></i>
                </td>
            </tr>
        </table>
    </header>
    <h2 style="text-align: center">Food safety</h2>
   @if($data['total_completed'] || $data['total_missed'] || $data['completedPer'] || $data['missedPer'] != 0)
   <div style="border: 3px solid black;border-collapse: collapse;">
       <img src="{{ $chartImagePath }}"
           style="margin-bottom: 0%" />
   </div>
   @endif
    <div style="margin-top: 3%">
        <table id="chart-table" style="border: 1px solid black;border-collapse: collapse;">
            <tr style="background-color:#757474;color:#ffffff">
                <th></th>
                <th>Completed Task</th>
                <th>Missed Task</th>
                <th>Completion Rate</th>
            </tr>
            @foreach ($value as $key => $val)
                <tr>
                    <td style="text-align: left">{{ $val['category_name'] }}</td>
                    <td>{{ $val['completed'] }}</td>
                    <td>{{ $val['missed'] }}</td>
                    <td>{{ $val['percentage'] . '%' }}</td>
                </tr>
            @endforeach
            <tr>
                <td style="text-align: left">Total</td>
                <td>{{ $data['total_completed'] }}</td>
                <td>{{ $data['total_missed'] }}</td>
                @if($data['total_completed'] || $data['total_missed'])
                    <td>{{ round(($data['total_completed'] * 100) / ($data['total_completed'] + $data['total_missed']), 0) . '%' }}
                    </td>
                @else
                    <td>0%</td>
                @endif
            </tr>
        </table>
        <main>
            @foreach ($unitCategory as $uc)
                <h4 style="text-align: center;font-size:30px;color: rgb(48, 46, 48);font-weight: bold;">
                    {{ $uc['name'] }}
                </h4>
                @foreach ($uc['units'] as $unit)
                    <div>
                        @if (!empty($unit['location_unit']))
                            @for ($k = 0; $k < $unit['location_unit']['qty']; $k++)
                                <table style="border: 1px solid black;border-collapse: collapse;">
                                    <tr>
                                        <th
                                            style="border: 1px solid black;  border-collapse: collapse; background-color:#757474;color:#ffffff">
                                            {{ $unit['name'] }}</th>
                                        @foreach ($unit['unit_validations'] as $uv)
                                            <th colspan="{{ count($unit['unit_schedules']) }}"
                                                style="border: 1px solid black;  border-collapse: collapse;
                                                background-color:#757474;color:#ffffff">
                                                {{ $uv['name'] }}
                                            </th>
                                        @endforeach
                                    </tr>
                                    @if (isset($unit['unit_schedules'][$k]['start_time']))
                                        @if (count($unit['unit_schedules']) > 1)
                                            <tr>
                                                <th style="border: 1px solid black;"></th>
                                                @foreach ($unit['unit_validations'] as $uv)
                                                    @foreach ($unit['unit_schedules'] as $us)
                                                        <th style="border: 1px solid black;">
                                                            {{ date('h:i A', strtotime($us['start_time'])) }}
                                                        </th>
                                                    @endforeach
                                                @endforeach
                                            </tr>
                                        @endif
                                    @endif
                                    @php
                                        $begin = new DateTime($start_date);
                                        $end = new DateTime($end_date);
                                        if ($duration == 'weekly') {
                                            $end = $end->modify('+1 day');
                                        }
                                        $interval = DateInterval::createFromDateString('1 day');
                                        $period = new DatePeriod($begin, $interval, $end);
                                    @endphp
                                    @if ($start_date != '' && $end_date != '')
                                        @foreach ($period as $dates)
                                            <tr>
                                                <td
                                                    style="border: 1px solid black;  border-collapse: collapse;text-align:left">
                                                    {{ \Carbon\Carbon::Create($dates)->format('m-d-Y') }}</td>
                                                @if (empty($unit['unit_schedules'][$k]['start_time']))
                                                    @foreach ($unit['unit_validations'] as $uv)
                                                        <th
                                                            style="border: 1px solid black;">123
                                                        </th>
                                                    @endforeach
                                                @else
                                                    @foreach ($unit['unit_validations'] as $uv)
                                                        @foreach ($unit['unit_schedules'] as $us)
                                                            @if (isset(
                                                                $build_task_result[$unit['id'] . '__' . $us['id'] . '__' . $dates->format('Y-m-d')][$k][$uv['id']]['result']) &&
                                                                !empty(
                                                                    $build_task_result[$unit['id'] . '__' . $us['id'] . '__' . $dates->format('Y-m-d')][$k][$uv['id']]['result']
                                                                ))
                                                                <td style="border: 1px solid black;text-align:center">
                                                                    {{ @$build_task_result[$unit['id'] . '__' . $us['id'] . '__' . $dates->format('Y-m-d')][$k][$uv['id']]['result'] }}
                                                                    <span>{{ $uv['measurement_symbol'] }}</span>
                                                                </td>
                                                            @else
                                                                <td
                                                                    style="border: 1px solid black;background-color:#ccc">
                                                                </td>
                                                            @endif
                                                        @endforeach
                                                    @endforeach
                                                @endif
                                            </tr>
                                        @endforeach
                                    @else
                                        <tr>
                                            <td style="border: 1px solid black;text-align:left">
                                                {{ \Carbon\Carbon::Create($date)->format('m-d-Y') }}
                                            </td>
                                            @if (empty($unit['unit_schedules'][$k]['start_time']))
                                                @foreach ($unit['unit_validations'] as $uv)
                                                    <td colspan="{{ count($unit['unit_schedules']) }}"
                                                        style="border: 1px solid black;"></td>
                                                @endforeach
                                            @else
                                                @php
                                                    $i = \Carbon\Carbon::Create($date)->format('Y-m-d');
                                                @endphp
                                                @foreach ($unit['unit_validations'] as $uv)
                                                    @foreach ($unit['unit_schedules'] as $us)
                                                        @if (isset($build_task_result[$unit['id'] . '__' . $us['id'] . '__' . $i][$k][$uv['id']]['result']) &&
                                                            !empty($build_task_result[$unit['id'] . '__' . $us['id'] . '__' . $i][$k][$uv['id']]['result']))
                                                            <td style="border: 1px solid black;text-align:center">
                                                                {{ @$build_task_result[$unit['id'] . '__' . $us['id'] . '__' . $i][$k][$uv['id']]['result'] }}
                                                                <span>{{ $uv['measurement_symbol'] }}</span>
                                                            </td>
                                                        @else
                                                            <td style="border: 1px solid black;background-color:#ccc">
                                                            </td>
                                                        @endif
                                                    @endforeach
                                                @endforeach
                                            @endif
                                        </tr>
                                    @endif
                                </table><br><br>
                            @endfor
                        @endif
                    </div>
                @endforeach
            @endforeach
        </main>
</body>
</html>
{{dd(123)}}


